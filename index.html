<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2C1810">
    <meta name="description" content="Interactive Rome travel map with custom pins and offline support">
    <title>Trip2Rome</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icons/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="icons/icon.svg">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

    <!-- Header -->
    <header id="header">
        <div class="header-left">
            <h1>Trip2Rome</h1>
        </div>
        <div class="header-right">
            <button id="btn-live-track" class="header-btn" title="Live Tracking" aria-pressed="false">
                <svg viewBox="0 0 24 24" width="22" height="22"><path fill="currentColor" d="M12 12c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 2c0-3.31-2.69-6-6-6s-6 2.69-6 6c0 2.22 1.21 4.15 3 5.19l1-1.74c-1.19-.7-2-1.97-2-3.45 0-2.21 1.79-4 4-4s4 1.79 4 4c0 1.48-.81 2.75-2 3.45l1 1.74c1.79-1.04 3-2.97 3-5.19zM12 4C7.31 4 3.07 7.09 1 11.45l1.97.85C4.73 8.79 8.09 6 12 6s7.27 2.79 9.03 6.3l1.97-.85C21 7.09 16.69 4 12 4z"/></svg>
                <span class="tracking-badge"></span>
            </button>
            <button id="btn-my-location" class="header-btn" title="My Location">
                <svg viewBox="0 0 24 24" width="22" height="22"><path fill="currentColor" d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3A8.994 8.994 0 0013 3.06V1h-2v2.06A8.994 8.994 0 003.06 11H1v2h2.06A8.994 8.994 0 0011 20.94V23h2v-2.06A8.994 8.994 0 0020.94 13H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>
            </button>
            <button id="btn-fit-all" class="header-btn" title="Show All Pins">
                <svg viewBox="0 0 24 24" width="22" height="22"><path fill="currentColor" d="M3 5v4h2V5h4V3H5c-1.1 0-2 .9-2 2zm2 10H3v4c0 1.1.9 2 2 2h4v-2H5v-4zm14 4h-4v2h4c1.1 0 2-.9 2-2v-4h-2v4zm0-16h-4v2h4v4h2V5c0-1.1-.9-2-2-2z"/></svg>
            </button>
            <button id="btn-route" class="header-btn" title="Show Route">
                <svg viewBox="0 0 24 24" width="22" height="22"><path fill="currentColor" d="M21.71 11.29l-9-9a.996.996 0 00-1.41 0l-9 9a.996.996 0 000 1.41l9 9c.39.39 1.02.39 1.41 0l9-9a.996.996 0 000-1.41zM14 14.5V12h-4v3H8v-4c0-.55.45-1 1-1h5V7.5l3.5 3.5-3.5 3.5z"/></svg>
            </button>
            <button id="btn-download" class="header-btn" title="Download Offline Map">
                <svg viewBox="0 0 24 24" width="22" height="22"><path fill="currentColor" d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
            </button>
            <button id="btn-collab" class="header-btn" title="Collaborate">
                <svg viewBox="0 0 24 24" width="22" height="22"><path fill="currentColor" d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                <span id="collab-badge" class="collab-badge"></span>
            </button>
            <button id="btn-list" class="header-btn" title="Location List">
                <svg viewBox="0 0 24 24" width="22" height="22"><path fill="currentColor" d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>
            </button>
        </div>
    </header>

    <!-- Day Tabs -->
    <div id="day-tabs" class="day-tabs">
        <button class="day-tab active" data-day="all">All</button>
    </div>

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Floating Action Button - AI Add -->
    <button id="fab-ai" title="AI Add Location">
        <svg viewBox="0 0 24 24" width="22" height="22"><path fill="currentColor" d="M19 9l1.25-2.75L23 5l-2.75-1.25L19 1l-1.25 2.75L15 5l2.75 1.25L19 9zm-7.5.5L9 4 6.5 9.5 1 12l5.5 2.5L9 20l2.5-5.5L17 12l-5.5-2.5zM19 15l-1.25 2.75L15 19l2.75 1.25L19 23l1.25-2.75L23 19l-2.75-1.25L19 15z"/></svg>
    </button>

    <!-- Floating Action Button - Add Location -->
    <button id="fab-add" title="Add Location">
        <svg viewBox="0 0 24 24" width="28" height="28"><path fill="currentColor" d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
    </button>

    <!-- Add Mode Banner -->
    <div id="add-mode-banner" class="hidden">
        <span>Tap the map to place a pin</span>
        <button id="btn-use-gps" class="banner-btn">Use GPS</button>
        <button id="btn-cancel-add" class="banner-btn cancel">Cancel</button>
    </div>

    <!-- Route Info Bar -->
    <div id="route-bar" class="hidden">
        <span id="route-info"></span>
        <button id="btn-route-gmaps" class="banner-btn">Open in Maps</button>
        <button id="btn-route-close" class="banner-btn cancel">Close</button>
    </div>

    <!-- Overlay -->
    <div id="overlay" class="hidden"></div>

    <!-- Location Detail Bottom Sheet -->
    <div id="detail-sheet" class="bottom-sheet hidden">
        <div class="sheet-handle"></div>
        <div class="sheet-content">
            <div class="detail-header">
                <span id="detail-dot" class="category-dot"></span>
                <h2 id="detail-name"></h2>
            </div>
            <div class="detail-meta">
                <p id="detail-category"></p>
                <p id="detail-address"></p>
            </div>
            <div class="detail-schedule">
                <div class="detail-day-chips" id="detail-day-chips"></div>
                <input type="time" id="detail-time-input" class="detail-time-input" />
            </div>
            <p id="detail-notes" class="detail-notes"></p>
            <div class="sheet-actions">
                <button id="btn-visited" class="action-btn visited-btn">
                    <span id="btn-visited-icon"></span>
                    <span id="btn-visited-label"></span>
                </button>
            </div>
            <div class="sheet-actions">
                <button id="btn-navigate" class="action-btn primary">
                    <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M21.71 11.29l-9-9a.996.996 0 00-1.41 0l-9 9a.996.996 0 000 1.41l9 9c.39.39 1.02.39 1.41 0l9-9a.996.996 0 000-1.41zM14 14.5V12h-4v3H8v-4c0-.55.45-1 1-1h5V7.5l3.5 3.5-3.5 3.5z"/></svg>
                    Navigate
                </button>
                <button id="btn-edit" class="action-btn">Edit</button>
                <button id="btn-delete" class="action-btn danger">Delete</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Location Bottom Sheet -->
    <div id="add-sheet" class="bottom-sheet hidden">
        <div class="sheet-handle"></div>
        <div class="sheet-content">
            <h2 id="add-sheet-title">Add Location</h2>
            <form id="location-form">
                <div class="form-group">
                    <label for="input-name">Name *</label>
                    <input type="text" id="input-name" required placeholder="e.g., Best Gelato Spot">
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <div id="category-selector" class="category-grid"></div>
                </div>
                <div class="form-group">
                    <label for="input-address">Address</label>
                    <input type="text" id="input-address" placeholder="Street address (optional)">
                </div>
                <div class="form-row">
                    <div class="form-group half">
                        <label for="input-date">Date</label>
                        <input type="date" id="input-date">
                    </div>
                    <div class="form-group half">
                        <label for="input-time">Time</label>
                        <input type="time" id="input-time">
                    </div>
                </div>
                <div class="form-group">
                    <label for="input-notes">Notes</label>
                    <textarea id="input-notes" rows="3" placeholder="Tips, links, reminders..."></textarea>
                </div>
                <input type="hidden" id="input-lat">
                <input type="hidden" id="input-lng">
                <input type="hidden" id="input-id">
                <div class="sheet-actions">
                    <button type="button" id="btn-cancel-form" class="action-btn">Cancel</button>
                    <button type="submit" id="btn-save" class="action-btn primary">Save Location</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Location List Bottom Sheet -->
    <div id="list-sheet" class="bottom-sheet hidden">
        <div class="sheet-handle"></div>
        <div class="sheet-content">
            <div class="list-header">
                <h2>Locations</h2>
                <div id="filter-chips" class="filter-chips"></div>
            </div>
            <div id="location-list" class="location-list"></div>
        </div>
    </div>

    <!-- Tracking Status (screen reader) -->
    <div id="tracking-status" class="sr-only" aria-live="polite"></div>

    <!-- AI Add Bottom Sheet -->
    <div id="ai-sheet" class="bottom-sheet hidden">
        <div class="sheet-handle"></div>
        <div class="sheet-content">
            <h2 id="ai-sheet-title">AI Pin Creator</h2>

            <!-- Input Section -->
            <div id="ai-input-section">
                <div class="form-group">
                    <label>Paste text or image</label>
                    <textarea id="ai-text-input" rows="5" placeholder="Paste any text about Rome locations â€” travel blogs, reviews, notes, screenshots..."></textarea>
                </div>

                <div id="ai-image-preview" class="ai-image-preview hidden">
                    <img id="ai-preview-img" src="" alt="Pasted image">
                    <button type="button" id="btn-remove-image" class="ai-remove-img" title="Remove image">&times;</button>
                </div>

                <div class="ai-toolbar">
                    <label class="ai-file-label" for="ai-file-input">
                        <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                        Add image
                    </label>
                    <input type="file" id="ai-file-input" accept="image/*" class="hidden">
                    <button type="button" id="btn-ai-settings" class="ai-settings-btn" title="API Key Settings">
                        <svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 00.12-.61l-1.92-3.32a.49.49 0 00-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 00-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96a.49.49 0 00-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.07.62-.07.94s.02.64.07.94l-2.03 1.58a.49.49 0 00-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                    </button>
                </div>

                <div class="sheet-actions">
                    <button type="button" id="btn-ai-cancel" class="action-btn">Cancel</button>
                    <button type="button" id="btn-ai-extract" class="action-btn primary">
                        <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M19 9l1.25-2.75L23 5l-2.75-1.25L19 1l-1.25 2.75L15 5l2.75 1.25L19 9zm-7.5.5L9 4 6.5 9.5 1 12l5.5 2.5L9 20l2.5-5.5L17 12l-5.5-2.5z"/></svg>
                        Extract Locations
                    </button>
                </div>
            </div>

            <!-- Loading State -->
            <div id="ai-loading" class="ai-loading hidden">
                <div class="ai-spinner"></div>
                <p>Analyzing content...</p>
            </div>

            <!-- Results Section -->
            <div id="ai-results-section" class="hidden">
                <p id="ai-results-summary" class="ai-results-summary"></p>
                <div id="ai-results-list" class="ai-results-list"></div>
                <div class="sheet-actions">
                    <button type="button" id="btn-ai-back" class="action-btn">Back</button>
                    <button type="button" id="btn-ai-add-all" class="action-btn primary">Add All to Map</button>
                </div>
            </div>
        </div>
    </div>

    <!-- API Key Modal -->
    <div id="ai-key-modal" class="modal hidden">
        <div class="modal-content">
            <h3>AI Settings</h3>
            <p class="ai-key-hint">Your key is stored locally in this browser only.</p>
            <div class="form-group">
                <label for="ai-provider-select">Provider</label>
                <div class="ai-provider-tabs">
                    <button type="button" class="ai-provider-tab active" data-provider="google">Google Gemini</button>
                    <button type="button" class="ai-provider-tab" data-provider="anthropic">Anthropic Claude</button>
                </div>
            </div>
            <div class="form-group">
                <label for="ai-key-input">API Key</label>
                <input type="password" id="ai-key-input" placeholder="">
            </div>
            <div class="sheet-actions">
                <button type="button" id="btn-key-cancel" class="action-btn">Cancel</button>
                <button type="button" id="btn-key-save" class="action-btn primary">Save</button>
            </div>
        </div>
    </div>

    <!-- Trip Settings Modal -->
    <div id="trip-settings-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Trip Dates</h3>
            <p class="trip-settings-hint">Set your travel dates to enable daily planning.</p>
            <div class="form-row">
                <div class="form-group half">
                    <label for="trip-start-date">Start</label>
                    <input type="date" id="trip-start-date">
                </div>
                <div class="form-group half">
                    <label for="trip-end-date">End</label>
                    <input type="date" id="trip-end-date">
                </div>
            </div>
            <div class="sheet-actions">
                <button type="button" id="btn-trip-cancel" class="action-btn">Cancel</button>
                <button type="button" id="btn-trip-clear" class="action-btn danger">Clear</button>
                <button type="button" id="btn-trip-save" class="action-btn primary">Save</button>
            </div>
        </div>
    </div>

    <!-- Collaboration Modal -->
    <div id="collab-modal" class="modal hidden">
        <div class="modal-content collab-modal-content">
            <h3>Collaborate</h3>

            <!-- Not connected state -->
            <div id="collab-create-section">
                <p class="collab-hint">Share your trip so both of you see the same pins, plans, and routes in real time.</p>

                <button type="button" id="btn-collab-create" class="action-btn primary collab-action-btn">
                    <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                    Create Shared Trip
                </button>

                <div class="collab-divider"><span>or join existing</span></div>

                <div class="collab-join-row">
                    <input type="text" id="collab-join-input" placeholder="ABC123" maxlength="6" class="collab-code-input">
                    <button type="button" id="btn-collab-join" class="action-btn primary collab-join-btn">Join</button>
                </div>
            </div>

            <!-- Connected state -->
            <div id="collab-connected-section" class="hidden">
                <p class="collab-hint">You're syncing in real time. Share this code with your travel partner:</p>
                <div class="collab-code-box">
                    <span id="collab-code-display" class="collab-code-text"></span>
                    <button type="button" id="btn-collab-copy" class="collab-copy-btn" title="Copy code">
                        <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                    </button>
                </div>
                <button type="button" id="btn-collab-disconnect" class="action-btn danger collab-action-btn">Disconnect</button>
            </div>

            <div class="collab-footer">
                <button type="button" id="btn-collab-setup" class="collab-setup-link">Firebase Settings</button>
                <button type="button" id="btn-collab-close" class="action-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Firebase Setup Modal -->
    <div id="firebase-setup-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Firebase Setup</h3>
            <div class="firebase-steps">
                <p>One-time setup (free):</p>
                <ol>
                    <li>Go to <strong>console.firebase.google.com</strong></li>
                    <li>Create a project (any name)</li>
                    <li>Build &rarr; Realtime Database &rarr; Create</li>
                    <li>Rules tab &rarr; set <code>".read": true, ".write": true</code></li>
                    <li>Copy the database URL below</li>
                </ol>
            </div>
            <div class="form-group">
                <label for="firebase-url-input">Database URL</label>
                <input type="url" id="firebase-url-input" placeholder="https://your-project-default-rtdb.firebaseio.com">
            </div>
            <div class="sheet-actions">
                <button type="button" id="btn-firebase-cancel" class="action-btn">Cancel</button>
                <button type="button" id="btn-firebase-save" class="action-btn primary">Save</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast hidden"></div>

    <!-- Download Progress Modal -->
    <div id="download-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Downloading Offline Map</h3>
            <p id="download-status">Preparing...</p>
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill"></div>
            </div>
            <p id="download-percent">0%</p>
            <button id="btn-cancel-download" class="action-btn">Cancel</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
